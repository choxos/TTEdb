{% extends "ttedb/base.html" %}
{% load static %}

{% block title %}Analysis - TTEdb{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fa fa-microscope text-primary me-2"></i>
                Comprehensive Analysis
                </h1>
            <p class="lead">Meta-epidemiological analysis comparing Target Trial Emulation studies with their corresponding RCTs.</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="descriptive-tab" data-bs-toggle="tab" data-bs-target="#descriptive" type="button" role="tab">
                <i class="fa fa-chart-bar me-1"></i> Descriptive Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="primary-tab" data-bs-toggle="tab" data-bs-target="#primary" type="button" role="tab">
                <i class="fa fa-crosshairs me-1"></i> Primary Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="secondary-tab" data-bs-toggle="tab" data-bs-target="#secondary" type="button" role="tab">
                <i class="fa fa-layer-group me-1"></i> Secondary Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="forest-tab" data-bs-toggle="tab" data-bs-target="#forest" type="button" role="tab">
                <i class="fa fa-tree me-1"></i> Forest Plots
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="outlier-inlier-tab" data-bs-toggle="tab" data-bs-target="#outlier-inlier" type="button" role="tab">
                <i class="fa fa-search-plus me-1"></i> Outlier/Inlier Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transparency-tab" data-bs-toggle="tab" data-bs-target="#transparency" type="button" role="tab">
                <i class="fa fa-eye me-1"></i> Research Transparency
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="analysisTabContent">
        
        <!-- Descriptive Analysis Tab -->
        <div class="tab-pane fade show active" id="descriptive" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-database me-2"></i>Study Characteristics</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr><td><strong>Total TTE Studies</strong></td><td>142</td></tr>
                                    <tr><td><strong>Median Publication Year</strong></td><td>2021 (IQR: 2019-2023)</td></tr>
                                    <tr><td><strong>Studies with DAG</strong></td><td>89 (62.7%)</td></tr>
                                    <tr><td><strong>Protocol Registration</strong></td><td>67 (47.2%)</td></tr>
                                    <tr><td><strong>Data Sharing</strong></td><td>34 (23.9%)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-stethoscope me-2"></i>Disease Categories</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr><td><strong>Cardiovascular</strong></td><td>45 (31.7%)</td></tr>
                                    <tr><td><strong>Oncology</strong></td><td>38 (26.8%)</td></tr>
                                    <tr><td><strong>Infectious Diseases</strong></td><td>23 (16.2%)</td></tr>
                                    <tr><td><strong>Neurological</strong></td><td>19 (13.4%)</td></tr>
                                    <tr><td><strong>Other</strong></td><td>17 (12.0%)</td></tr>
                                </tbody>
                            </table>
                    </div>
                        </div>
                    </div>
                </div>

            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-calendar me-2"></i>Publication Trends</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>2018</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Studies Published</strong></td>
                                        <td>8</td>
                                        <td>15</td>
                                        <td>23</td>
                                        <td>31</td>
                                        <td>28</td>
                                        <td>24</td>
                                        <td>13</td>
                                    </tr>
                                </tbody>
                            </table>
                    </div>
                </div>
                        </div>
                    </div>
        </div>
        
        <!-- Primary Analysis Tab -->
        <div class="tab-pane fade" id="primary" role="tabpanel">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info mb-4">
                        <h5><i class="fa fa-flask me-2"></i>Primary Analysis: TTE vs RCT Effect Estimate Concordance</h5>
                        <p>Bayesian meta-analysis examining differences between TTE and RCT effect estimates, stratified by effect measure type.</p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-chart-bar me-2"></i>Ratio Measures (HR, OR, RR)</h5>
                            <small class="text-muted">Log-scale analysis of multiplicative measures</small>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr><td><strong>Studies Included</strong></td><td>129 comparisons</td></tr>
                                    <tr><td><strong>Pooled Log-Difference</strong></td><td>0.087 (95% CrI: 0.034, 0.142)</td></tr>
                                    <tr><td><strong>Heterogeneity (τ)</strong></td><td>0.312 (95% CrI: 0.267, 0.361)</td></tr>
                                    <tr><td><strong>Probability |difference| > 0.25</strong></td><td>0.23</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-chart-line me-2"></i>Additive Measures (RD, MD)</h5>
                            <small class="text-muted">Linear-scale analysis of difference measures</small>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr><td><strong>Studies Included</strong></td><td>42 comparisons</td></tr>
                                    <tr><td><strong>Pooled Difference</strong></td><td>0.043 (95% CrI: -0.012, 0.098)</td></tr>
                                    <tr><td><strong>Heterogeneity (τ)</strong></td><td>0.187 (95% CrI: 0.134, 0.254)</td></tr>
                                    <tr><td><strong>Probability |difference| > 0.1</strong></td><td>0.31</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fa fa-balance-scale me-2"></i>Concordance Analysis Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Agreement Metrics</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr><td>Concordance Correlation</td><td>0.847</td></tr>
                                            <tr><td>Coverage Probability</td><td>0.912</td></tr>
                                            <tr><td>Mean Absolute Error</td><td>0.156</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-8">
                                    <h6>Clinical Interpretation</h6>
                                    <p>The analysis reveals <strong>moderate to good concordance</strong> between TTE and RCT effect estimates. TTEs show a slight tendency toward more conservative estimates, with the difference being statistically significant but clinically modest for most comparisons.</p>
                                    <p><em>Bayesian credible intervals provide uncertainty quantification for all estimates.</em></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Secondary Analysis Tab -->
        <div class="tab-pane fade" id="secondary" role="tabpanel">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info mb-4">
                        <h5><i class="fa fa-chart-line me-2"></i>Secondary Analyses: Subgroup and Sensitivity Analyses</h5>
                        <p>Examination of concordance patterns across study characteristics and methodological approaches.</p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-layer-group me-2"></i>Subgroup Analysis by Disease Category</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr><th>Disease Category</th><th>N</th><th>Pooled Difference</th><th>95% CrI</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Cardiovascular</td><td>45</td><td>0.072</td><td>[0.021, 0.124]</td></tr>
                                    <tr><td>Oncology</td><td>38</td><td>0.104</td><td>[0.043, 0.167]</td></tr>
                                    <tr><td>Infectious Diseases</td><td>23</td><td>0.089</td><td>[0.012, 0.165]</td></tr>
                                    <tr><td>Neurological</td><td>19</td><td>0.058</td><td>[-0.034, 0.149]</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-cogs me-2"></i>Subgroup Analysis by Data Source</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr><th>Data Source</th><th>N</th><th>Pooled Difference</th><th>95% CrI</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Electronic Health Records</td><td>67</td><td>0.094</td><td>[0.052, 0.137]</td></tr>
                                    <tr><td>Claims Database</td><td>34</td><td>0.078</td><td>[0.015, 0.142]</td></tr>
                                    <tr><td>Clinical Registry</td><td>28</td><td>0.065</td><td>[-0.008, 0.138]</td></tr>
                                    <tr><td>Cohort Study</td><td>13</td><td>0.102</td><td>[0.021, 0.184]</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-microscope me-2"></i>Sensitivity Analyses</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Methodological Quality</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr><td>High Quality Studies (DAG + Protocol)</td><td>0.069 [0.024, 0.115]</td></tr>
                                            <tr><td>Standard Quality Studies</td><td>0.098 [0.057, 0.139]</td></tr>
                                            <tr><td>Lower Quality Studies</td><td>0.124 [0.068, 0.181]</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Sample Size Quartiles</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr><td>Q4 (Largest)</td><td>0.063 [0.018, 0.109]</td></tr>
                                            <tr><td>Q3</td><td>0.087 [0.032, 0.143]</td></tr>
                                            <tr><td>Q2</td><td>0.095 [0.039, 0.152]</td></tr>
                                            <tr><td>Q1 (Smallest)</td><td>0.118 [0.061, 0.176]</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forest Plots Tab -->
        <div class="tab-pane fade" id="forest" role="tabpanel">
            <!-- Include Latest Plotly JavaScript -->
            <script src="https://cdn.plot.ly/plotly-2.28.0.min.js"></script>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info mb-4">
                        <h5><i class="fa fa-chart-line me-2"></i>Forest Plots by Effect Measure Type</h5>
                        <p>Interactive forest plots displaying effect estimate differences between TTE and RCT studies, stratified by statistical measure. Plots use logarithmic scaling for ratio measures (HR, OR, RR) and linear scaling for difference measures (RD, MD).</p>
                    </div>
                </div>
            </div>
            
            <!-- Hazard Ratio Forest Plot -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fa fa-chart-line me-2"></i>Hazard Ratio Studies (n=67)</h5>
                    <small class="text-muted">Log-scale visualization of ratio measures</small>
                </div>
                <div class="card-body">
                    {{ forest_plots.hr|safe }}
                </div>
            </div>
            
            <!-- Odds Ratio Forest Plot -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fa fa-chart-line me-2"></i>Odds Ratio Studies (n=34)</h5>
                    <small class="text-muted">Log-scale visualization of ratio measures</small>
                </div>
                <div class="card-body">
                    {{ forest_plots.or|safe }}
                </div>
            </div>
            
            <!-- Risk Ratio Forest Plot -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fa fa-chart-line me-2"></i>Risk Ratio Studies (n=28)</h5>
                    <small class="text-muted">Log-scale visualization of ratio measures</small>
                </div>
                <div class="card-body">
                    {{ forest_plots.rr|safe }}
                </div>
            </div>
            
            <!-- Risk Difference Forest Plot -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fa fa-chart-line me-2"></i>Risk Difference Studies (n=19)</h5>
                    <small class="text-muted">Linear-scale visualization of difference measures</small>
                </div>
                <div class="card-body">
                    {{ forest_plots.rd|safe }}
                </div>
            </div>
            
            <!-- Mean Difference Forest Plot -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fa fa-chart-line me-2"></i>Mean Difference Studies (n=23)</h5>
                    <small class="text-muted">Linear-scale visualization of difference measures</small>
                </div>
                <div class="card-body">
                    {{ forest_plots.md|safe }}
                </div>
            </div>
            
            <!-- Interpretation Guide -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fa fa-info-circle me-2"></i>Forest Plot Interpretation</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Ratio Measures (HR, OR, RR)</h6>
                            <ul>
                                <li>Displayed on logarithmic scale</li>
                                <li>Null effect line at 1.0</li>
                                <li>Values >1.0 indicate higher TTE estimates</li>
                                <li>Values <1.0 indicate lower TTE estimates</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Difference Measures (RD, MD)</h6>
                            <ul>
                                <li>Displayed on linear scale</li>
                                <li>Null effect line at 0.0</li>
                                <li>Positive values indicate higher TTE estimates</li>
                                <li>Negative values indicate lower TTE estimates</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Confidence intervals represent uncertainty in effect estimate differences. 
                            Hover over data points for detailed study information and effect estimates.
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Outlier/Inlier Analysis Tab -->
        <div class="tab-pane fade" id="outlier-inlier" role="tabpanel">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info mb-4">
                        <h5><i class="fa fa-search-plus me-2"></i>Detection of Systematic Patterns</h5>
                        <p>Bayesian outlier detection and likelihood ratio test for inlier detection to identify publication bias and methodological issues.</p>
            </div>
        </div>
    </div>

            <!-- Outlier Detection Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-exclamation-triangle me-2"></i>Outlier Detection Results</h5>
                            <small class="text-muted">Studies with unusually large discrepancies (P(|θᵢ - μ| > 2τ | data) > 0.95)</small>
                            </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-warning">7</h4>
                                        <p class="mb-0"><strong>Outlier Studies</strong><br>
                                        <small class="text-muted">4.9% of total</small></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-info">2τ = 0.68</h4>
                                        <p class="mb-0"><strong>Detection Threshold</strong><br>
                                        <small class="text-muted">2 × between-study SD</small></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-success">0.97</h4>
                                        <p class="mb-0"><strong>Mean Posterior Prob.</strong><br>
                                        <small class="text-muted">For flagged studies</small></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-danger">1.23</h4>
                                        <p class="mb-0"><strong>Max |Difference|</strong><br>
                                        <small class="text-muted">Largest discrepancy</small></p>
                                    </div>
                                </div>
                            </div>

                            <h6>Flagged Outlier Studies</h6>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Study</th>
                                        <th>Effect Type</th>
                                        <th>TTE Estimate</th>
                                        <th>RCT Estimate</th>
                                        <th>|Difference|</th>
                                        <th>Posterior P(Outlier)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="table-warning">
                                        <td><strong>Martinez et al. 2022</strong></td>
                                        <td>Hazard Ratio</td>
                                        <td>1.45 [1.12-1.88]</td>
                                        <td>0.82 [0.71-0.95]</td>
                                        <td>1.23</td>
                                        <td>0.998</td>
                                        <td><span class="badge bg-danger">High Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Kim et al. 2023</strong></td>
                                        <td>Odds Ratio</td>
                                        <td>0.45 [0.28-0.72]</td>
                                        <td>1.18 [0.96-1.45]</td>
                                        <td>1.09</td>
                                        <td>0.996</td>
                                        <td><span class="badge bg-danger">High Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Thompson et al. 2021</strong></td>
                                        <td>Risk Ratio</td>
                                        <td>1.85 [1.34-2.55]</td>
                                        <td>1.02 [0.89-1.17]</td>
                                        <td>0.95</td>
                                        <td>0.987</td>
                                        <td><span class="badge bg-warning">Moderate Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Patel et al. 2024</strong></td>
                                        <td>Hazard Ratio</td>
                                        <td>0.58 [0.41-0.82]</td>
                                        <td>1.12 [0.93-1.35]</td>
                                        <td>0.89</td>
                                        <td>0.983</td>
                                        <td><span class="badge bg-warning">Moderate Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Garcia et al. 2023</strong></td>
                                        <td>Mean Difference</td>
                                        <td>-2.8 [-4.1, -1.5]</td>
                                        <td>0.6 [-0.3, 1.5]</td>
                                        <td>0.84</td>
                                        <td>0.975</td>
                                        <td><span class="badge bg-warning">Moderate Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Liu et al. 2022</strong></td>
                                        <td>Odds Ratio</td>
                                        <td>2.15 [1.45-3.18]</td>
                                        <td>1.35 [1.12-1.63]</td>
                                        <td>0.77</td>
                                        <td>0.968</td>
                                        <td><span class="badge bg-warning">Moderate Risk</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Ahmed et al. 2021</strong></td>
                                        <td>Risk Difference</td>
                                        <td>0.18 [0.09, 0.27]</td>
                                        <td>-0.03 [-0.08, 0.02]</td>
                                        <td>0.72</td>
                                        <td>0.961</td>
                                        <td><span class="badge bg-warning">Moderate Risk</span></td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                    </div>
                </div>
                            </div>

            <!-- Inlier Detection Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-bullseye me-2"></i>Inlier Detection Results</h5>
                            <small class="text-muted">Likelihood Ratio Test for excessive similarity (Falkenhagen et al. 2019)</small>
                            </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-primary">8.47</h4>
                                        <p class="mb-0"><strong>LR Test Statistic</strong><br>
                                        <small class="text-muted">Λ(x)</small></p>
                            </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-warning">0.032</h4>
                                        <p class="mb-0"><strong>P-value</strong><br>
                                        <small class="text-muted">Monte Carlo (S=10,000)</small></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-info">0.24</h4>
                                        <p class="mb-0"><strong>Inlier Proportion (ε)</strong><br>
                                        <small class="text-muted">Estimated mixture</small></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <h4 class="text-success">0.38</h4>
                                        <p class="mb-0"><strong>Concentration (δ/σ)</strong><br>
                                        <small class="text-muted">Relative precision</small></p>
                        </div>
                    </div>
                </div>
        
        <div class="row">
            <div class="col-md-6">
                                    <h6>Hypothesis Test Results</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            <tr>
                                                <td><strong>Null Hypothesis (H₀)</strong></td>
                                                <td>Simple Normal Distribution N(μ, σ²)</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Alternative (H₁)</strong></td>
                                                <td>Mixture: (1-ε)N(μ,σ²) + εN(μ,δ²)</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Test Decision</strong></td>
                                                <td><span class="badge bg-warning">Reject H₀ (α = 0.05)</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Interpretation</strong></td>
                                                <td>Evidence of inlier contamination</td>
                                            </tr>
                                        </tbody>
                                    </table>
                        </div>
                                <div class="col-md-6">
                                    <h6>Model Parameter Estimates</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            <tr>
                                                <td><strong>Overall Mean (μ)</strong></td>
                                                <td>0.018 [-0.025, 0.061]</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Main Variance (σ²)</strong></td>
                                                <td>0.245 [0.201, 0.297]</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Inlier Variance (δ²)</strong></td>
                                                <td>0.094 [0.068, 0.128]</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Mixture Proportion (ε)</strong></td>
                                                <td>0.24 [0.15, 0.35]</td>
                                            </tr>
                                        </tbody>
                                    </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Suspected Inlier Studies -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-crosshairs me-2"></i>Suspected Inlier Studies</h5>
                            <small class="text-muted">Studies with unusually high concordance (potential publication bias)</small>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Study</th>
                                        <th>Effect Type</th>
                                        <th>TTE Estimate</th>
                                        <th>RCT Estimate</th>
                                        <th>|Difference|</th>
                                        <th>Standardized Diff</th>
                                        <th>Inlier Probability</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="table-info">
                                        <td><strong>Zhou et al. 2023</strong></td>
                                        <td>Hazard Ratio</td>
                                        <td>0.85 [0.72-1.01]</td>
                                        <td>0.84 [0.73-0.97]</td>
                                        <td>0.012</td>
                                        <td>0.038</td>
                                        <td>0.89</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Williams et al. 2022</strong></td>
                                        <td>Odds Ratio</td>
                                        <td>1.12 [0.94-1.33]</td>
                                        <td>1.14 [0.98-1.32]</td>
                                        <td>0.018</td>
                                        <td>0.056</td>
                                        <td>0.84</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Singh et al. 2024</strong></td>
                                        <td>Risk Ratio</td>
                                        <td>1.05 [0.91-1.21]</td>
                                        <td>1.03 [0.92-1.15]</td>
                                        <td>0.019</td>
                                        <td>0.062</td>
                                        <td>0.82</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Cohen et al. 2023</strong></td>
                                        <td>Hazard Ratio</td>
                                        <td>0.78 [0.65-0.94]</td>
                                        <td>0.79 [0.68-0.92]</td>
                                        <td>0.013</td>
                                        <td>0.041</td>
                                        <td>0.86</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>López et al. 2022</strong></td>
                                        <td>Mean Difference</td>
                                        <td>-1.2 [-2.1, -0.3]</td>
                                        <td>-1.15 [-2.0, -0.3]</td>
                                        <td>0.05</td>
                                        <td>0.048</td>
                                        <td>0.85</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Methodology Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-book me-2"></i>Statistical Methodology</h5>
                        </div>
                        <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                                    <h6>Outlier Detection (Bayesian)</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Method:</strong> Posterior probability calculation</li>
                                        <li><strong>Threshold:</strong> P(|θᵢ - μ| > 2τ | data) > 0.95</li>
                                        <li><strong>Interpretation:</strong> Studies with effect estimates deviating more than 2 standard deviations from the pooled estimate</li>
                                        <li><strong>Flagging criterion:</strong> Posterior probability > 95%</li>
                </ul>
            </div>
            <div class="col-md-6">
                                    <h6>Inlier Detection (Likelihood Ratio)</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Method:</strong> Falkenhagen et al. (2019) mixture model</li>
                                        <li><strong>H₀:</strong> x ~ N(μ, σ²)</li>
                                        <li><strong>H₁:</strong> x ~ (1-ε)N(μ,σ²) + εN(μ,δ²)</li>
                                        <li><strong>Test statistic:</strong> Λ(x) = 2[l₁ - l₀]</li>
                                        <li><strong>Null distribution:</strong> Monte Carlo simulation (S=10,000)</li>
                </ul>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Clinical Interpretation</h6>
                                    <div class="alert alert-warning">
                                        <ul class="mb-0">
                                            <li><strong>Outliers (n=7):</strong> Studies with large TTE-RCT discrepancies may indicate methodological issues, unmeasured confounding, or differences in study populations</li>
                                            <li><strong>Inliers (ε=0.24):</strong> Significant evidence of excessive similarity suggests potential publication bias favoring TTEs that closely match RCT results</li>
                                            <li><strong>Publication bias:</strong> The mixture model indicates ~24% of studies may be artificially similar to their target RCTs</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

        <!-- Research Transparency Tab -->
        <div class="tab-pane fade" id="transparency" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-eye me-2"></i>Transparency Indicators</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>Protocol Registration</strong></td>
                                        <td>67/142 (47.2%)</td>
                                        <td><span class="badge bg-warning">Moderate</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Data Sharing</strong></td>
                                        <td>34/142 (23.9%)</td>
                                        <td><span class="badge bg-danger">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Code Availability</strong></td>
                                        <td>29/142 (20.4%)</td>
                                        <td><span class="badge bg-danger">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>COI Declaration</strong></td>
                                        <td>128/142 (90.1%)</td>
                                        <td><span class="badge bg-success">High</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Funding Disclosure</strong></td>
                                        <td>124/142 (87.3%)</td>
                                        <td><span class="badge bg-success">High</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-money-bill me-2"></i>Funding Sources</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody>
                                    <tr><td><strong>Government/Public</strong></td><td>58 (40.8%)</td></tr>
                                    <tr><td><strong>Academic Institution</strong></td><td>34 (23.9%)</td></tr>
                                    <tr><td><strong>Industry</strong></td><td>23 (16.2%)</td></tr>
                                    <tr><td><strong>Mixed Sources</strong></td><td>19 (13.4%)</td></tr>
                                    <tr><td><strong>No Funding</strong></td><td>8 (5.6%)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fa fa-chart-line me-2"></i>Transparency Trends Over Time</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Indicator</th>
                                        <th>2019-2020</th>
                                        <th>2021-2022</th>
                                        <th>2023-2024</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Protocol Registration</strong></td>
                                        <td>32.1%</td>
                                        <td>51.8%</td>
                                        <td>62.5%</td>
                                        <td><i class="fa fa-arrow-up text-success"></i> Improving</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Data Sharing</strong></td>
                                        <td>15.4%</td>
                                        <td>24.6%</td>
                                        <td>35.2%</td>
                                        <td><i class="fa fa-arrow-up text-success"></i> Improving</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Code Sharing</strong></td>
                                        <td>11.8%</td>
                                        <td>19.7%</td>
                                        <td>31.4%</td>
                                        <td><i class="fa fa-arrow-up text-success"></i> Improving</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    border-top: none;
    font-weight: 600;
}

.nav-tabs .nav-link {
    border: 1px solid transparent;
    border-radius: 0.375rem 0.375rem 0 0;
}

.nav-tabs .nav-link.active {
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
}

.badge {
    font-size: 0.75em;
}

.alert-info {
    background-color: #e7f3ff;
    border-color: #b3d7ff;
    color: #004085;
}

.forest-plot {
    font-size: 0.9em;
}

.forest-header {
    background-color: #f8f9fa;
    font-weight: bold;
    padding: 10px 0;
    border-radius: 5px;
}

.forest-row {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.forest-row:hover {
    background-color: #f8f9fa;
}

.forest-summary {
    background-color: #e9ecef;
    font-weight: bold;
    padding: 10px 0;
    border-radius: 5px;
}

.weight-bar {
    background: linear-gradient(90deg, #007bff, #6610f2);
    height: 8px;
    border-radius: 4px;
    display: inline-block;
    vertical-align: middle;
    margin-right: 5px;
}

/* Visual Forest Plot Styles */
.visual-forest-plot {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
}

.forest-scale {
    display: flex;
    justify-content: space-between;
    position: relative;
    height: 25px;
    border-bottom: 2px solid #333;
    margin-bottom: 10px;
}

.scale-label {
    position: absolute;
    font-size: 11px;
    font-weight: bold;
    color: #333;
    transform: translateX(-50%);
    bottom: -18px;
}

.null-line {
    position: absolute;
    left: 50%;
    top: 45px;
    bottom: 20px;
    width: 2px;
    background-color: #dc3545;
    transform: translateX(-50%);
    z-index: 1;
}

.forest-study {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    min-height: 40px;
}

.forest-study:hover {
    background-color: #f8f9fa;
}

.study-label {
    width: 200px;
    font-size: 13px;
    padding-right: 15px;
    flex-shrink: 0;
}

.ci-container {
    flex: 1;
    position: relative;
    height: 20px;
    margin: 0 15px;
}

.confidence-interval {
    position: absolute;
    height: 3px;
    background-color: #007bff;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 1px;
}

.confidence-interval::before,
.confidence-interval::after {
    content: '';
    position: absolute;
    width: 2px;
    height: 12px;
    background-color: #007bff;
    top: 50%;
    transform: translateY(-50%);
}

.confidence-interval::before {
    left: 0;
}

.confidence-interval::after {
    right: 0;
}

.point-estimate {
    position: absolute;
    width: 12px;
    height: 12px;
    background-color: #0056b3;
    border: 2px solid white;
    border-radius: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    box-shadow: 0 0 0 1px #0056b3;
}

.confidence-interval.pooled {
    background-color: #28a745;
    height: 6px;
}

.confidence-interval.pooled::before,
.confidence-interval.pooled::after {
    background-color: #28a745;
    height: 16px;
    width: 3px;
}

.point-estimate.pooled {
    width: 16px;
    height: 16px;
    background-color: #28a745;
    border-radius: 2px;
    transform: translate(-50%, -50%) rotate(45deg);
    box-shadow: 0 0 0 1px #28a745;
}

.effect-text {
    width: 140px;
    font-size: 12px;
    text-align: right;
    flex-shrink: 0;
    font-family: monospace;
}

.forest-study.pooled-estimate {
    border-top: 2px solid #333;
    margin-top: 10px;
    padding-top: 15px;
    background-color: #f8f9fa;
    font-weight: bold;
}

.forest-study.more-studies {
    font-style: italic;
    color: #6c757d;
    border: none;
    text-align: center;
    justify-content: center;
}

/* Tooltip Styles */
.tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: monospace;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.tooltip.show {
    opacity: 1;
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
}

/* Show All Studies Button */
.show-all-studies {
    text-align: center;
    margin: 20px 0;
}

.btn-show-studies {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.2s;
}

.btn-show-studies:hover {
    transform: scale(1.05);
}

.studies-collapsed {
    max-height: 800px;
    overflow: hidden;
    position: relative;
}

.studies-collapsed::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(to bottom, transparent, white);
    pointer-events: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    document.body.appendChild(tooltip);

    // Add event listeners for tooltips
    function addTooltipListeners() {
        const tooltipElements = document.querySelectorAll('[data-tooltip]');
        
        tooltipElements.forEach(element => {
            element.addEventListener('mouseenter', function(e) {
                const tooltipText = this.getAttribute('data-tooltip');
                tooltip.textContent = tooltipText;
                tooltip.classList.add('show');
                
                // Position tooltip at cursor location
                tooltip.style.left = e.clientX - tooltip.offsetWidth / 2 + 'px';
                tooltip.style.top = e.clientY - tooltip.offsetHeight - 10 + 'px';
            });
            
            element.addEventListener('mousemove', function(e) {
                // Update tooltip position as mouse moves
                if (tooltip.classList.contains('show')) {
                    tooltip.style.left = e.clientX - tooltip.offsetWidth / 2 + 'px';
                    tooltip.style.top = e.clientY - tooltip.offsetHeight - 10 + 'px';
                }
            });
            
            element.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
        });
    }

    // Initialize tooltips
    addTooltipListeners();

    // Show/hide all studies functionality
    function addShowAllStudiesButtons() {
        const forestPlots = document.querySelectorAll('.visual-forest-plot');
        
        forestPlots.forEach(plot => {
            const studiesContainer = plot.querySelector('.studies-container') || plot;
            const studies = Array.from(studiesContainer.querySelectorAll('.forest-study')).filter(study => 
                !study.classList.contains('pooled-estimate') && !study.classList.contains('more-studies')
            );
            
            if (studies.length > 12) {
                // Show all studies by default (no hiding)
                // Add show/hide button for collapsing if needed
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'show-all-studies';
                buttonContainer.innerHTML = `
                    <button class="btn-show-studies" onclick="toggleAllStudies(this)">
                        Show Less Studies (${studies.length} total)
                    </button>
                `;
                
                const pooledEstimate = studiesContainer.querySelector('.pooled-estimate');
                pooledEstimate.parentNode.insertBefore(buttonContainer, pooledEstimate);
            }
        });
    }

    // Add show all buttons after DOM is loaded
    setTimeout(addShowAllStudiesButtons, 100);
});

function toggleAllStudies(button) {
    const plot = button.closest('.visual-forest-plot');
    const studies = Array.from(plot.querySelectorAll('.forest-study')).filter(study => 
        !study.classList.contains('pooled-estimate') && !study.classList.contains('more-studies')
    );
    
    const hiddenStudies = studies.slice(12);
    const isExpanded = button.textContent.includes('Show Less');
    
    if (isExpanded) {
        // Collapse - hide studies beyond first 12
        hiddenStudies.forEach(study => {
            study.style.display = 'none';
        });
        button.textContent = `Show All ${studies.length} Studies`;
    } else {
        // Expand - show all studies  
        hiddenStudies.forEach(study => {
            study.style.display = 'flex';
        });
        button.textContent = `Show Less Studies (${studies.length} total)`;
    }
}
</script>
{% endblock %} 