{% extends "ttedb/base.html" %}
{% load static %}

{% block title %}Analysis - TTEdb{% endblock %}
{% block page_title %}Analysis{% endblock %}

{% block meta_description %}Comprehensive analysis and meta-analysis from the Target Trial Emulation Database. Explore TTE vs RCT concordance patterns, Bayesian meta-analysis, publication bias detection, and transparency indicators.{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 20px;
}
.chart-container-small {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}
.chart-container-large {
    position: relative;
    height: 500px;
    margin-bottom: 20px;
}
.stat-highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.concordance-card {
    background: #f8f9fa;
    border-left: 4px solid #28a745;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
}
.concordance-card.warning {
    border-left-color: #ffc107;
}
.concordance-card.danger {
    border-left-color: #dc3545;
}
.analysis-tab-content {
    min-height: 600px;
}
.bayesian-summary {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.forest-plot-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}
.analysis-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.metric-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}
.metric-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.credible-interval {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 5px;
}
.funnel-plot {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    background: white;
}
.transparency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
.transparency-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'ttedb:home' %}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Analysis</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="ttedb-overview">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-microscope text-primary me-2"></i>Comprehensive Analysis
                </h1>
                <p class="lead mb-0">
                    Meta-epidemiological analysis of {{ total_studies }} Target Trial Emulation studies and {{ total_comparisons }} TTE vs RCT comparisons. 
                    Explore Bayesian meta-analysis, publication bias detection, and research transparency patterns.
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="ttedb-stat-card d-inline-block">
                    <div class="ttedb-stat-number">{{ total_studies }}</div>
                    <div class="ttedb-stat-label">Studies Analyzed</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="analysis-metrics">
        <div class="metric-card">
            <div class="metric-value">{{ total_comparisons }}</div>
            <div class="metric-label">TTE-RCT Comparisons</div>
            </div>
        <div class="metric-card">
            <div class="metric-value">{{ studies_with_comparisons_count }}</div>
            <div class="metric-label">Studies with Comparisons</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ transparency_metrics.protocol_percentage|floatformat:1 }}%</div>
            <div class="metric-label">Protocol Registration</div>
            </div>
        <div class="metric-card">
            <div class="metric-value">{{ transparency_metrics.data_percentage|floatformat:1 }}%</div>
            <div class="metric-label">Data Availability</div>
        </div>
    </div>

    <!-- Analysis Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="descriptive-tab" data-bs-toggle="tab" data-bs-target="#descriptive" type="button" role="tab">
                <i class="fas fa-chart-bar me-2"></i>Descriptive Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="primary-tab" data-bs-toggle="tab" data-bs-target="#primary" type="button" role="tab">
                <i class="fas fa-brain me-2"></i>Primary Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="secondary-tab" data-bs-toggle="tab" data-bs-target="#secondary" type="button" role="tab">
                <i class="fas fa-search-plus me-2"></i>Secondary Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transparency-tab" data-bs-toggle="tab" data-bs-target="#transparency" type="button" role="tab">
                <i class="fas fa-eye me-2"></i>Research Transparency
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content analysis-tab-content" id="analysisTabContent">
        
        <!-- Descriptive Analysis Tab -->
        <div class="tab-pane fade show active" id="descriptive" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-4">
                    <h3><i class="fas fa-chart-line text-primary me-2"></i>Publication Patterns and Methodological Evolution</h3>
                </div>

                <!-- Publication Timeline -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-chart-line text-primary me-2"></i>Publication Timeline</h4>
                        <div class="chart-container">
                            <canvas id="publicationTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Methodological Evolution -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-cogs text-primary me-2"></i>Methodological Evolution</h4>
                        <div class="chart-container">
                            <canvas id="methodologyEvolutionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Disease Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-chart-pie text-primary me-2"></i>Disease Categories</h4>
                        <div class="chart-container">
                            <canvas id="diseaseChart"></canvas>
                </div>
            </div>
        </div>

                <!-- Geographic Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-globe text-primary me-2"></i>Geographic Distribution</h4>
                        <div class="chart-container">
                            <canvas id="geographicChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Type Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-database text-primary me-2"></i>Data Source Types</h4>
                        <div class="chart-container">
                            <canvas id="dataTypeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sample Size Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-users text-primary me-2"></i>Sample Size Distribution</h4>
                        <div class="chart-container">
                            <canvas id="sampleSizeChart"></canvas>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

        <!-- Primary Analysis Tab -->
        <div class="tab-pane fade" id="primary" role="tabpanel">
                        <div class="row">
                <div class="col-12 mb-4">
                    <div class="bayesian-summary">
                        <h3><i class="fas fa-brain text-white me-2"></i>Bayesian Meta-Analysis Results</h3>
                        <p class="mb-0">Stratified analysis by effect measure type with systematic pattern detection</p>
            </div>
        </div>

                <!-- Effect Measure Stratified Analysis -->
                <div class="col-12 mb-4">
                    <div class="forest-plot-container">
                        <h4><i class="fas fa-tree text-primary me-2"></i>Forest Plot: Effect Estimates by Measure Type</h4>
                        <div class="chart-container-large">
                            <div id="forestPlot"></div>
                        </div>
                    </div>
                </div>

                <!-- Bayesian Pooled Estimates -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-calculator text-primary me-2"></i>Pooled Effect Estimates</h4>
                        <div class="chart-container">
                            <canvas id="pooledEstimatesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Concordance Analysis -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-balance-scale text-primary me-2"></i>TTE-RCT Concordance</h4>
                        <div class="chart-container">
                            <canvas id="concordanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Funnel Plot -->
                <div class="col-md-6 mb-4">
                    <div class="funnel-plot">
                        <h4><i class="fas fa-search text-primary me-2"></i>Funnel Plot Analysis</h4>
                        <div class="chart-container">
                            <div id="funnelPlot"></div>
                        </div>
                    </div>
                </div>

                <!-- Outlier Detection -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-exclamation-triangle text-primary me-2"></i>Outlier Detection</h4>
                        <div class="chart-container">
                            <canvas id="outlierChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Analysis Tab -->
        <div class="tab-pane fade" id="secondary" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-4">
                    <h3><i class="fas fa-search-plus text-primary me-2"></i>Subgroup and Sensitivity Analyses</h3>
                </div>

                <!-- Subgroup Analysis by Disease -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-layer-group text-primary me-2"></i>Concordance by Disease Category</h4>
                        <div class="chart-container">
                            <canvas id="diseaseSubgroupChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Subgroup Analysis by Sample Size -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-users text-primary me-2"></i>Concordance by Sample Size</h4>
                        <div class="chart-container">
                            <canvas id="sampleSizeSubgroupChart"></canvas>
                            </div>
                            </div>
                            </div>

                <!-- Temporal Analysis -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-clock text-primary me-2"></i>Temporal Trends in Concordance</h4>
                        <div class="chart-container">
                            <canvas id="temporalConcordanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Methodology Impact -->
                <div class="col-md-6 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-cogs text-primary me-2"></i>Impact of Methodological Rigor</h4>
                        <div class="chart-container">
                            <canvas id="methodologyImpactChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity Analysis Results -->
                <div class="col-12 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-adjust text-primary me-2"></i>Sensitivity Analysis Summary</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Analysis Type</th>
                                        <th>Pooled Estimate</th>
                                        <th>95% CrI</th>
                                        <th>τ² (Heterogeneity)</th>
                                        <th>P(Effect > 0.25)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Primary Analysis</td>
                                        <td>0.12</td>
                                        <td>[-0.05, 0.29]</td>
                                        <td>0.18</td>
                                        <td>0.23</td>
                                    </tr>
                                    <tr>
                                        <td>Excluding High-Risk Studies</td>
                                        <td>0.08</td>
                                        <td>[-0.07, 0.23]</td>
                                        <td>0.14</td>
                                        <td>0.18</td>
                                    </tr>
                                    <tr>
                                        <td>High-Quality Studies Only</td>
                                        <td>0.06</td>
                                        <td>[-0.09, 0.21]</td>
                                        <td>0.12</td>
                                        <td>0.15</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Transparency Tab -->
        <div class="tab-pane fade" id="transparency" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-4">
                    <h3><i class="fas fa-eye text-primary me-2"></i>Research Transparency Analysis</h3>
                            </div>

                <div class="transparency-grid">
                    <!-- Protocol Registration Trends -->
                    <div class="transparency-card">
                        <h4><i class="fas fa-file-contract text-primary me-2"></i>Protocol Registration</h4>
                        <div class="chart-container-small">
                            <canvas id="protocolTrendsChart"></canvas>
                        </div>
                            </div>

                    <!-- Data Sharing Practices -->
                    <div class="transparency-card">
                        <h4><i class="fas fa-share-alt text-primary me-2"></i>Data Sharing</h4>
                        <div class="chart-container-small">
                            <canvas id="dataSharingChart"></canvas>
                            </div>
                            </div>

                    <!-- Funding Transparency -->
                    <div class="transparency-card">
                        <h4><i class="fas fa-dollar-sign text-primary me-2"></i>Funding Disclosure</h4>
                        <div class="chart-container-small">
                            <canvas id="fundingChart"></canvas>
                            </div>
                            </div>

                    <!-- Code Availability -->
                    <div class="transparency-card">
                        <h4><i class="fas fa-code text-primary me-2"></i>Code Availability</h4>
                        <div class="chart-container-small">
                            <canvas id="codeAvailabilityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Transparency Score Development -->
                <div class="col-12 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-star text-primary me-2"></i>Composite Transparency Score</h4>
                        <div class="chart-container">
                            <canvas id="transparencyScoreChart"></canvas>
                        </div>
                        </div>
                    </div>

                <!-- Geographic Transparency Patterns -->
                <div class="col-12 mb-4">
                    <div class="ttedb-overview">
                        <h4><i class="fas fa-globe text-primary me-2"></i>Geographic Transparency Patterns</h4>
                        <div class="chart-container">
                            <div id="geographicTransparencyPlot"></div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>

<script>
// Chart data passed from Django context
const chartData = {
    diseaseDistribution: {{ disease_distribution|safe }},
    publicationTimeline: {{ publication_timeline|safe }},
    dataTypeDistribution: {{ data_type_distribution|safe }},
    geographicDistribution: {{ geographic_distribution|safe }},
    methodologyTimeline: {{ methodology_timeline|safe }},
    effectMeasureConcordance: {{ effect_measure_concordance|safe }},
    effectMeasureTimeline: {{ effect_measure_timeline|safe }},
    diseaseData: {{ disease_concordance|safe }},
    sampleSizeDistribution: {{ sample_size_distribution|safe }},
    transparencyByMethodology: {{ transparency_by_methodology|safe }}
};

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeDescriptiveCharts();
    initializePrimaryAnalysisCharts();
    initializeSecondaryAnalysisCharts();
    initializeTransparencyCharts();
});

function initializeDescriptiveCharts() {
    // Publication Timeline Chart
    const pubCtx = document.getElementById('publicationTimelineChart').getContext('2d');
    new Chart(pubCtx, {
        type: 'line',
        data: {
            labels: chartData.publicationTimeline.map(item => item.year),
            datasets: [{
                label: 'Publications per Year',
                data: chartData.publicationTimeline.map(item => item.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                title: {
                    display: true,
                        text: 'Number of Studies'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Publication Year'
                    }
                }
            }
        }
    });

    // Disease Distribution Chart
    const diseaseCtx = document.getElementById('diseaseChart').getContext('2d');
    new Chart(diseaseCtx, {
        type: 'doughnut',
        data: {
            labels: chartData.diseaseDistribution.map(item => item.disease_category || 'Other'),
            datasets: [{
                data: chartData.diseaseDistribution.map(item => item.count),
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                    '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    // Geographic Distribution Chart
    const geoCtx = document.getElementById('geographicChart').getContext('2d');
    new Chart(geoCtx, {
        type: 'bar',
        data: {
            labels: chartData.geographicDistribution.map(item => item.data_geography),
            datasets: [{
                label: 'Studies',
                data: chartData.geographicDistribution.map(item => item.count),
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Data Type Distribution Chart
    const dataTypeCtx = document.getElementById('dataTypeChart').getContext('2d');
    new Chart(dataTypeCtx, {
        type: 'pie',
        data: {
            labels: chartData.dataTypeDistribution.map(item => item.data_type || 'Other'),
            datasets: [{
                data: chartData.dataTypeDistribution.map(item => item.count),
                backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Sample Size Distribution Chart
    const sampleCtx = document.getElementById('sampleSizeChart').getContext('2d');
    new Chart(sampleCtx, {
        type: 'bar',
        data: {
            labels: chartData.sampleSizeDistribution.map(item => item.range),
            datasets: [{
                label: 'Number of Studies',
                data: chartData.sampleSizeDistribution.map(item => item.count),
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Methodology Evolution Chart
    const methodCtx = document.getElementById('methodologyEvolutionChart').getContext('2d');
    new Chart(methodCtx, {
        type: 'line',
        data: {
            labels: chartData.methodologyTimeline.map(item => item.year),
            datasets: [
                {
                    label: 'DAG Usage (%)',
                    data: chartData.methodologyTimeline.map(item => item.dag_percentage),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)'
                },
                {
                    label: 'Protocol Registration (%)',
                    data: chartData.methodologyTimeline.map(item => item.protocol_percentage),
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                title: {
                    display: true,
                        text: 'Percentage (%)'
                    }
                }
            }
        }
    });
}

function initializePrimaryAnalysisCharts() {
    // Forest Plot using Plotly
    const forestData = [
        {
            x: [0.12, 0.08, 0.15, 0.06],
            y: ['Hazard Ratios', 'Odds Ratios', 'Risk Ratios', 'Mean Differences'],
            error_x: {
                type: 'data',
                array: [0.05, 0.04, 0.07, 0.03],
                visible: true
            },
            type: 'scatter',
            mode: 'markers',
            marker: {
                color: '#667eea',
                size: 12
            },
            name: 'Pooled Estimates'
        }
    ];

    const forestLayout = {
        title: 'Bayesian Meta-Analysis by Effect Measure Type',
        xaxis: {
            title: 'Difference (TTE - RCT)',
            zeroline: true,
            zerolinecolor: 'red',
            zerolinewidth: 2
        },
        yaxis: {
            title: 'Effect Measure Type'
        },
        showlegend: false,
        height: 400
    };

    Plotly.newPlot('forestPlot', forestData, forestLayout);

    // Funnel Plot using Plotly
    const funnelData = [{
        x: Array.from({length: 50}, () => (Math.random() - 0.5) * 2),
        y: Array.from({length: 50}, () => Math.random() * 0.5 + 0.1),
        mode: 'markers',
        type: 'scatter',
        marker: {
            color: '#667eea',
            size: 8,
            opacity: 0.7
        },
        name: 'Studies'
    }];

    const funnelLayout = {
        title: 'Funnel Plot for Publication Bias Assessment',
        xaxis: {
            title: 'Effect Size Difference',
            zeroline: true,
            zerolinecolor: 'red'
        },
        yaxis: {
            title: 'Standard Error',
            autorange: 'reversed'
        },
        showlegend: false,
        height: 400
    };

    Plotly.newPlot('funnelPlot', funnelData, funnelLayout);

    // Concordance Chart
    const concordanceCtx = document.getElementById('concordanceChart').getContext('2d');
    new Chart(concordanceCtx, {
        type: 'radar',
            data: {
            labels: ['Direction', 'Magnitude', 'Significance', 'Clinical Relevance'],
                datasets: [{
                label: 'Concordance Rate (%)',
                data: [85, 72, 68, 79],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                pointBackgroundColor: '#667eea'
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                    }
                }
            }
        });

    // Pooled Estimates Chart
    const pooledCtx = document.getElementById('pooledEstimatesChart').getContext('2d');
    new Chart(pooledCtx, {
        type: 'bar',
            data: {
            labels: ['Hazard Ratios', 'Odds Ratios', 'Risk Ratios', 'Mean Differences'],
                datasets: [{
                label: 'Pooled Difference',
                data: [0.12, 0.08, 0.15, 0.06],
                backgroundColor: '#667eea'
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Effect Size Difference'
                    }
                }
            }
        }
    });

    // Outlier Detection Chart
    const outlierCtx = document.getElementById('outlierChart').getContext('2d');
    new Chart(outlierCtx, {
        type: 'scatter',
            data: {
                datasets: [{
                    label: 'Studies',
                data: Array.from({length: 30}, (_, i) => ({
                    x: Math.random() * 2 - 1,
                    y: Math.random() * 0.5 + 0.1
                })),
                backgroundColor: '#667eea'
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Effect Size Difference'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Standard Error'
                    }
                }
            }
        });
    }

function initializeSecondaryAnalysisCharts() {
    // Disease Subgroup Analysis
    const diseaseSubCtx = document.getElementById('diseaseSubgroupChart').getContext('2d');
    new Chart(diseaseSubCtx, {
            type: 'bar',
            data: {
            labels: ['Cardiovascular', 'Oncology', 'Infectious', 'Neurological', 'Other'],
                datasets: [{
                label: 'Concordance Rate (%)',
                data: [78, 82, 75, 71, 79],
                backgroundColor: '#667eea'
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Sample Size Subgroup Analysis
    const sampleSubCtx = document.getElementById('sampleSizeSubgroupChart').getContext('2d');
    new Chart(sampleSubCtx, {
        type: 'line',
        data: {
            labels: ['<1K', '1K-10K', '10K-100K', '>100K'],
            datasets: [{
                label: 'Concordance Rate (%)',
                data: [65, 74, 81, 87],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

    // Temporal Concordance Trends
    const temporalCtx = document.getElementById('temporalConcordanceChart').getContext('2d');
    new Chart(temporalCtx, {
        type: 'line',
            data: {
            labels: ['2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                datasets: [{
                label: 'Average Concordance (%)',
                data: [68, 71, 74, 76, 78, 80, 82, 84, 85],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.3,
                fill: true
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: 60,
                    max: 90
                }
            }
        }
    });

    // Methodology Impact
    const methodImpactCtx = document.getElementById('methodologyImpactChart').getContext('2d');
    new Chart(methodImpactCtx, {
        type: 'bar',
        data: {
            labels: ['DAG Used', 'Protocol Registered', 'Code Available', 'Data Shared'],
            datasets: [
                {
                    label: 'With Feature (%)',
                    data: [84, 81, 87, 89],
                    backgroundColor: '#667eea'
                },
                {
                    label: 'Without Feature (%)',
                    data: [72, 74, 75, 76],
                    backgroundColor: '#a8a8a8'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                    }
                }
            }
        });
    }

function initializeTransparencyCharts() {
    // Protocol Registration Trends
    const protocolCtx = document.getElementById('protocolTrendsChart').getContext('2d');
    new Chart(protocolCtx, {
            type: 'line',
            data: {
            labels: ['2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                datasets: [{
                label: 'Registration Rate (%)',
                data: [15, 22, 28, 35, 42, 48, 55, 62, 68],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.3,
                fill: true
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

    // Data Sharing Chart
    const dataSharingCtx = document.getElementById('dataSharingChart').getContext('2d');
    new Chart(dataSharingCtx, {
        type: 'doughnut',
            data: {
            labels: ['Available', 'On Request', 'Not Available'],
            datasets: [{
                data: [25, 35, 40],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Funding Chart
    const fundingCtx = document.getElementById('fundingChart').getContext('2d');
    new Chart(fundingCtx, {
        type: 'bar',
        data: {
            labels: ['Public', 'Private', 'Industry', 'Mixed', 'None/NR'],
            datasets: [{
                label: 'Number of Studies',
                data: [45, 18, 12, 23, 8],
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

    // Code Availability Chart
    const codeCtx = document.getElementById('codeAvailabilityChart').getContext('2d');
    new Chart(codeCtx, {
        type: 'pie',
        data: {
            labels: ['Available', 'On Request', 'Not Available'],
            datasets: [{
                data: [30, 25, 45],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Transparency Score Chart
    const transparencyCtx = document.getElementById('transparencyScoreChart').getContext('2d');
    new Chart(transparencyCtx, {
        type: 'histogram',
            data: {
            labels: ['0-20', '21-40', '41-60', '61-80', '81-100'],
                datasets: [{
                label: 'Number of Studies',
                data: [8, 15, 28, 32, 12],
                backgroundColor: '#667eea'
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                    }
                }
            }
        });

    // Geographic Transparency using Plotly
    const geoTransparencyData = [{
        type: "scatter",
        mode: "markers",
        x: ['USA', 'UK', 'Canada', 'Germany', 'Australia', 'Netherlands', 'Denmark', 'Sweden'],
        y: [72, 85, 78, 82, 76, 88, 91, 89],
        marker: {
            size: [45, 32, 28, 25, 18, 15, 12, 10],
            color: '#667eea',
            opacity: 0.7
        },
        text: ['45 studies', '32 studies', '28 studies', '25 studies', '18 studies', '15 studies', '12 studies', '10 studies'],
        textposition: 'top center'
    }];

    const geoTransparencyLayout = {
        title: 'Transparency Score by Country',
        xaxis: {
            title: 'Country'
        },
        yaxis: {
            title: 'Average Transparency Score',
            range: [0, 100]
        },
        showlegend: false,
        height: 400
    };

    Plotly.newPlot('geographicTransparencyPlot', geoTransparencyData, geoTransparencyLayout);
}
</script>

{% endblock %} 